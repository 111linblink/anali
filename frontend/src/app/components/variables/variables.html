<div class="container-fluid p-4">
  <!-- Header con información general -->
  <div class="row mb-3">
    <div class="col-12">
      <h2>Selección de variables para análisis</h2>
      <div class="row mt-2">
        <div class="col-md-2">
          <small class="text-muted">Total Filas: </small>
          <strong>{{ infoGeneral.totalFilas }}</strong>
        </div>
        <div class="col-md-2">
          <small class="text-muted">Total Temas: </small>
          <strong>{{ infoGeneral.totalTemas }}</strong>
        </div>
        <div class="col-md-3">
          <small class="text-muted">Mapeo: </small>
          <strong>{{ estadisticasMapeo.porcentajeExito }}% ({{ estadisticasMapeo.preguntasMapeadas }}/{{ estadisticasMapeo.totalPreguntas }})</strong>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-info btn-sm" (click)="verificarMapeo()">
            Debug Info
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles de expansión -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-primary" (click)="expandirTodosTemas()">
          Expandir Todos
        </button>
        <button type="button" class="btn btn-outline-secondary" (click)="contraerTodosTemas()">
          Contraer Todos
        </button>
      </div>
    </div>
  </div>

  <!-- Selección de temas -->
  <div class="tema-container" *ngFor="let tema of temas">
    <div class="tema-header" (click)="toggleTemaExpansion(tema)">
      <label class="tema-label" (click)="$event.stopPropagation()">
        <input type="checkbox" 
               [(ngModel)]="seleccionTema[tema]" 
               (change)="toggleTema(tema)" />
        <strong>{{ tema }}</strong>
      </label>
      <span class="expansion-icon">
        {{ temasExpandidos[tema] ? '▼' : '▶' }}
      </span>
    </div>
    
    <div class="preguntas-container" *ngIf="temasExpandidos[tema]">
      <ul class="preguntas-list">
        <li *ngFor="let pregunta of preguntasPorTema[tema]">
          <label class="pregunta-label">
            <input type="checkbox"
                   [(ngModel)]="seleccionPregunta[pregunta]"
                   (change)="onPreguntaToggle()" />
            {{ pregunta }}
          </label>
        </li>
      </ul>
    </div>
  </div>

  <hr />

  <!-- Tabla de previsualización con paginación -->
  <div *ngIf="preguntasSeleccionadas.length > 0">
    <h3>Previsualización de datos seleccionados</h3>
    
    <!-- Información de paginación -->
    <div class="row mb-3">
      <div class="col-md-6">
        <p class="mb-0">
          Mostrando {{ (paginaActual - 1) * filasPorPagina + 1 }} a 
          {{ Math.min(paginaActual * filasPorPagina, datos.length) }} de 
          {{ datos.length }} filas
        </p>
      </div>
      <div class="col-md-6 text-end">
        <label class="me-2">
          Filas por página:
          <select [(ngModel)]="filasPorPagina" (change)="paginaActual = 1; calcularPaginacion()" class="form-select form-select-sm d-inline-block w-auto ms-1">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </label>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th *ngFor="let col of preguntasVisibles">{{ col }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let fila of datosPaginados">
            <td *ngFor="let col of preguntasVisibles">
              {{ fila[col] !== undefined ? fila[col] : '-' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Controles de paginación -->
    <nav aria-label="Paginación de tabla" *ngIf="totalPaginas > 1">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="paginaActual === 1">
          <button class="page-link" (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1">
            Anterior
          </button>
        </li>
        <li class="page-item" 
            *ngFor="let pagina of paginasArray" 
            [class.active]="pagina === paginaActual">
          <button class="page-link" (click)="cambiarPagina(pagina)">
            {{ pagina }}
          </button>
        </li>
        <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
          <button class="page-link" (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas">
            Siguiente
          </button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Gráfica -->
  <div class="mt-4" *ngIf="graficaDataset.labels.length > 0">
    <h3>Gráfica de promedios por tema</h3>
    <div class="chart-container">
      <canvas baseChart
              [data]="graficaDataset"
              [options]="graficaOpciones"
              [type]="'bar'">
      </canvas>
    </div>
  </div>

  <!-- Resultado de cluster -->
  <div *ngIf="clusterEstimado !== null" 
       class="resultado-cluster mt-4 p-3 rounded border" 
       [style.borderColor]="clusterColor">
    <strong>Grupo estimado (cluster): {{ clusterEstimado }}</strong><br />
    <span>{{ clusterDescripcion }}</span>
  </div>

  <!-- Radar Chart del Preanálisis por Pregunta -->
<div class="mt-4" *ngIf="radarDataset.labels.length > 0">
  <h3>Preanálisis basado en tus respuestas</h3>
  <div class="chart-container">
    <canvas baseChart
            [data]="radarDataset"
            [options]="radarOpciones"
            [type]="'radar'">
    </canvas>
  </div>
</div>

</div>