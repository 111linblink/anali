<div class="container-fluid p-4">
  <h2>Selección de variables para análisis</h2>

  <!-- Información general -->
  <div class="row mb-3">
    <div class="col-md-3">
      <small class="text-muted">Total Filas: </small>
      <strong>{{ infoGeneral.totalFilas }}</strong>
    </div>
    <div class="col-md-3">
      <small class="text-muted">Total Temas: </small>
      <strong>{{ infoGeneral.totalTemas }}</strong>
    </div>
    <div class="col-md-4">
      <small class="text-muted">Mapeo:</small>
      <strong>{{ estadisticasMapeo.porcentajeExito }}% ({{ estadisticasMapeo.preguntasMapeadas }}/{{ estadisticasMapeo.totalPreguntas }})</strong>
    </div>
    <div class="col-md-2 text-end">
      <button class="btn btn-outline-info btn-sm" (click)="verificarMapeo()">Debug Info</button>
    </div>
  </div>

  <!-- Controles de expansión -->
  <div class="mb-3">
    <button class="btn btn-outline-primary btn-sm me-2" (click)="expandirTodosTemas()">Expandir Todos</button>
    <button class="btn btn-outline-secondary btn-sm" (click)="contraerTodosTemas()">Contraer Todos</button>
  </div>

  <!-- Selección por temas y preguntas -->
  <div class="tema-container" *ngFor="let tema of temas">
    <div class="tema-header" (click)="toggleTemaExpansion(tema)">
      <label (click)="$event.stopPropagation()">
        <input type="checkbox" [(ngModel)]="seleccionTema[tema]" (change)="toggleTema(tema)" />
        <strong>{{ tema }}</strong>
      </label>
      <span class="expansion-icon">{{ temasExpandidos[tema] ? '▼' : '▶' }}</span>
    </div>

    <div class="preguntas-container" *ngIf="temasExpandidos[tema]">
      <ul>
        <li *ngFor="let pregunta of preguntasPorTema[tema]">
          <label>
            <input type="checkbox" [(ngModel)]="seleccionPregunta[pregunta]" (change)="onPreguntaToggle()" />
            {{ pregunta }}
          </label>
        </li>
      </ul>
    </div>
  </div>

  <hr />

  <!-- Selección por columnas directamente -->
  <div class="card mt-4">
    <div class="card-body">
      <h4 class="card-title">Variables disponibles (vista alternativa)</h4>
      <div class="mb-3">
        <button class="btn btn-secondary btn-sm me-2" (click)="selectAll()" [disabled]="allSelected">Seleccionar Todo</button>
        <button class="btn btn-secondary btn-sm" (click)="clearSelection()" [disabled]="!hasSelection">Limpiar Selección</button>
      </div>

      <div class="row">
        <div class="col-md-3" *ngFor="let col of columnas">
          <input type="checkbox" [(ngModel)]="selectedVariables[col]" (change)="updateSelection()" />
          <label>{{ col }}</label>
        </div>
      </div>

      <p class="mt-2">{{ getSelectionText() }}</p>
    </div>
  </div>

  <!-- Vista previa de datos -->
  <div *ngIf="variablesSeleccionadas.length > 0" class="mt-4">
    <h4>Vista previa de datos</h4>

    <div class="d-flex justify-content-between mb-2">
      <div>{{ dataRange }}</div>
      <div>
        <select class="form-select form-select-sm d-inline w-auto" [(ngModel)]="itemsPerPage" (change)="changeItemsPerPage(itemsPerPage)">
          <option *ngFor="let option of itemsPerPageOptions" [value]="option">{{ option }} por página</option>
        </select>
      </div>
    </div>

    <table class="table table-striped table-bordered table-sm">
      <thead>
        <tr>
          <th *ngFor="let col of variablesSeleccionadas">{{ col }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let fila of datosPaginados">
          <td *ngFor="let col of variablesSeleccionadas">{{ fila[col] }}</td>
        </tr>
      </tbody>
    </table>

    <nav *ngIf="totalPages > 1" class="mt-2">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="!canGoPrevious">
          <button class="page-link" (click)="previousPage()">«</button>
        </li>
        <li *ngFor="let page of pageNumbers" class="page-item" [class.active]="page === currentPage">
          <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
        </li>
        <li class="page-item" [class.disabled]="!canGoNext">
          <button class="page-link" (click)="nextPage()">»</button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Botones -->
  <div class="mt-4 text-end">
    <button class="btn btn-secondary me-2" (click)="volver()">Volver</button>
    <button class="btn btn-primary" (click)="continuarAnalisis()" [disabled]="!hasSelection">Analizar Variables</button>
  </div>

  <!-- Gráfica de barras -->
  <div *ngIf="graficaDataset.labels.length > 0" class="mt-5">
    <h4>Promedios por tema</h4>
    <canvas baseChart [data]="graficaDataset" [options]="graficaOpciones" [type]="'bar'"></canvas>
  </div>

  <!-- Resultado de cluster -->
  <div *ngIf="clusterEstimado !== null" class="alert mt-4" [style.borderColor]="clusterColor" style="border: 2px solid; padding: 10px;">
    <strong>Grupo estimado (cluster): {{ clusterEstimado }}</strong><br />
    <span>{{ clusterDescripcion }}</span>
  </div>

  <!-- Gráfica radar -->
  <div *ngIf="radarDataset.labels.length > 0" class="mt-4">
    <h4>Preanálisis basado en tus respuestas</h4>
    <canvas baseChart [data]="radarDataset" [options]="radarOpciones" [type]="'radar'"></canvas>
  </div>
</div>
